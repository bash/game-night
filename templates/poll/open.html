{% extends "base.html" %}

{% block title %}Poll{% endblock title %}

{% block content %}

{{ ParticipatedMessageComponent::for_poll(poll, user) | safe }}

<p>
    Hurray, you're invited to
    {{ LongEventTitleComponent::for_event(poll.event).untitled_prefix("another instance of") | safe }}
    ðŸŽ‰ <br>

    Fill out the poll until
        <strong>{{poll.open_until | time("{date}")}}</strong>
        at <strong>{{poll.open_until | time("{time}")}}</strong>
        to help pick the date.
</p>

{% if let Some(group) = poll.event.restrict_to %}
<p>
    This is a special game night just for members of
    <strong>Â«{{group.name}}Â»</strong>
    and will take place in <strong>{{poll.event.location.description}}</strong>.
</p>
{% else %}
<p>
    The game night will take place in <strong>{{poll.event.location.description}}</strong>.
</p>
{% endif %}

{% if !poll.event.description.is_empty() %}
    <section>
        {{poll.event.description | markdown | safe}}
    </section>
{% endif %}

<hr>

<form action="{{update_answers_uri}}" method="post">
    <p>
        I would like to attend {{ LongEventTitleComponent::for_event(poll.event) | safe }} on one of the following dates:
    </p>
    <div class="calendar-list">
        {% for group in option_groups %}
            <h2>{{group.name}}</h2>
            <ul>
                {% for option in group.options %}
                    <li {% if option.vetoed %}class="-vetoed"{% endif %}>
                        <div style="display: flex; align-items: center; gap: .2em;">
                            <input type="checkbox" name="options[{{option.id}}][yes]" id="option-{{option.id}}" {{*option.yes | checked}} autocomplete="off">

                            {% if can_answer_strongly %}
                                <span class="toggle-button">
                                    <input type="checkbox" name="options[{{option.id}}][strong]" id="option-{{option.id}}-strong" {{*option.strong | checked}} autocomplete="off">
                                    <label for="option-{{option.id}}-strong" tabindex="0">
                                        <span class="veto">Veto</span>
                                        <span class="required">Required</span>
                                    </label>
                                </span>
                            {% endif %}
                        </div>

                        <label for="option-{{option.id}}">
                            <span class="day">{{option.starts_at | time("[day padding:none]")}}</span>
                            <span class="weekday">
                                {{option.starts_at | time("[weekday repr:long]")}}
                            </span>
                        </label>

                        <div class="time-range">
                            <time>{{option.starts_at | time("[hour]:[minute]")}}</time>
                        </div>

                        <div class="answers-list">
                            {% if option.vetoed %}
                                <span class="error-message -inline">Vetoed!</span>
                            {% endif %}
                            {% for user in option.yes_answers %}
                                <span class="answer">
                                    {{ UserNameComponent::for_user(user).with_symbol() | safe }}
                                </span>
                            {% endfor %}
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% endfor %}
        {% if !no_date_answered_with_yes.is_empty() %}
            <h2>Skipped</h2>
            <ul>
                <li>
                    <div class="answers-list">
                        {% for user in no_date_answered_with_yes %}
                            <span class="answer">
                                {{ UserNameComponent::for_user(&user.to_v1()).with_symbol() | safe }}
                            </span>
                        {% endfor %}
                    </div>
                </li>
            </ul>
        {% endif %}
        {% if !not_answered.is_empty() %}
            <h2>No answer</h2>
            <ul>
                <li>
                    <div class="answers-list">
                        {% for user in not_answered %}
                            <span class="answer">
                                {{ UserNameComponent::for_user(&user.to_v1()).with_symbol() | safe }}
                            </span>
                        {% endfor %}
                    </div>
                </li>
            </ul>
        {% endif %}
    </div>
    <fieldset>
        <button type="submit" {% if !has_answers %}data-one-selected-label="Save Answers"{% endif %}>
            {% if has_answers %}
                Save Answers
            {% else %}
                None of the Above
            {% endif %}
        </button>
        {% if let Some(close_poll_uri) = close_poll_uri %}
            <a href="{{close_poll_uri}}" class="link-button">Close Poll&hellip;</a>
        {% endif %}
    </fieldset>
</form>

{% endblock content %}

{% block scripts %}
<script type="module" src='{{ctx.asset("/js/toggle-button.js")}}'></script>
<script type="module">
    const button = document.querySelector('[data-one-selected-label]')
    const defaultLabel = button.innerText
    let set = false

    for (const checkbox of document.querySelectorAll('input[type=checkbox]')) {
        checkbox.addEventListener('input', onInput)
    }

    function onInput() {
        if (!set) {
            set = true
            button.innerText = button.dataset.oneSelectedLabel;
        }
    }
</script>
{% endblock scripts %}
